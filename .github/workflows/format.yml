name: Format IP List

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡
    - cron: '0 11 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  format-ip:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Create format script
        run: |
          cat > format_ip.py << 'EOF'
          import requests

          # åœ°åŒºä»£ç åˆ°æ——å¸œå’Œä¸­æ–‡åç§°çš„æ˜ å°„
          region_mapping = {
              'HK': ('ðŸ‡­ðŸ‡°', 'é¦™æ¸¯'),
              'TW': ('ðŸ‡¹ðŸ‡¼', 'å°æ¹¾'),
              'US': ('ðŸ‡ºðŸ‡¸', 'ç¾Žå›½'),
              'JP': ('ðŸ‡¯ðŸ‡µ', 'æ—¥æœ¬'),
              'SG': ('ðŸ‡¸ðŸ‡¬', 'æ–°åŠ å¡'),
              'KR': ('ðŸ‡°ðŸ‡·', 'éŸ©å›½'),
              'DE': ('ðŸ‡©ðŸ‡ª', 'å¾·å›½'),
              'UK': ('ðŸ‡¬ðŸ‡§', 'è‹±å›½'),
              'FR': ('ðŸ‡«ðŸ‡·', 'æ³•å›½'),
              'CA': ('ðŸ‡¨ðŸ‡¦', 'åŠ æ‹¿å¤§'),
              'AU': ('ðŸ‡¦ðŸ‡º', 'æ¾³å¤§åˆ©äºš'),
              'IN': ('ðŸ‡®ðŸ‡³', 'å°åº¦'),
              'RU': ('ðŸ‡·ðŸ‡º', 'ä¿„ç½—æ–¯'),
              'CN': ('ðŸ‡¨ðŸ‡³', 'ä¸­å›½'),
              # å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šåœ°åŒºæ˜ å°„
          }

          def format_ip_list():
              # èŽ·å–åŽŸå§‹IPåˆ—è¡¨
              url = "https://raw.githubusercontent.com/kgdpyeifk/github-ip-speedtest/refs/heads/main/top10.txt"
              try:
                  response = requests.get(url)
                  response.raise_for_status()  # æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
              except requests.exceptions.RequestException as e:
                  print(f"èŽ·å–IPåˆ—è¡¨å¤±è´¥: {e}")
                  return False

              # å¤„ç†æ¯ä¸€è¡Œ
              formatted_lines = []
              for line in response.text.splitlines():
                  line = line.strip()
                  if not line:
                      continue
                      
                  # åˆ†å‰²IPå’Œåœ°åŒºä»£ç 
                  parts = line.split('#')
                  if len(parts) != 2:
                      # æ ¼å¼ä¸æ­£ç¡®çš„è¡Œï¼Œç›´æŽ¥ä¿ç•™åŽŸå†…å®¹
                      formatted_lines.append(line)
                      continue
                      
                  ip_port = parts[0]
                  region_code = parts[1]
                  
                  # èŽ·å–å¯¹åº”çš„æ——å¸œå’Œä¸­æ–‡åç§°ï¼Œå¦‚æžœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
                  flag, chinese_name = region_mapping.get(
                      region_code, 
                      ('ðŸ³ï¸', f'æœªçŸ¥({region_code})')
                  )
                  
                  # æ ¼å¼åŒ–æ–°è¡Œ
                  new_line = f"{ip_port}#{flag}{region_code}-{chinese_name}"
                  formatted_lines.append(new_line)

              # ä¿å­˜åˆ°æ–‡ä»¶
              try:
                  with open('ip.txt', 'w', encoding='utf-8') as f:
                      f.write('\n'.join(formatted_lines) + '\n')
                  return True
              except IOError as e:
                  print(f"å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")
                  return False

          if __name__ == "__main__":
              success = format_ip_list()
              exit(0 if success else 1)
          EOF

      - name: Run format script
        run: python format_ip.py

      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add ip.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
              echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
              exit 0
          fi
          
          git commit -m "Update IP list with formatted regions"
          git push
